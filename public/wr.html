<html>
	<head>
    	<link href="css/style.css" rel="stylesheet" type="text/css">
		<title>Index</title>
	</head>
	
	<body>
	
 		<!-- Send Message frame. A textbox and a send button. 
		<div class="msgframe">
			<div class="msghead"><strong>Broadcast message</strong></div>
			<div class="msgcontent">
				<input data-bind="value: msgToSend" /><button data-bind="click: wsTest">Send</button>
				<button data-bind="click: wsTestData">Test data</button>
			</div>
		</div>
		
		-->
		<!-- Result list: A table -->
		 


	<!-- result list -->
	  <div data-bind="visible:$root.viewerVisible()==false">
		<h1>Web retrieval</h1>
		<div class="msgframe" >
			<div class="msghead"><strong>Query results</strong></div>
			<div>
			<table>
			    <thead>
			        <tr  data-bind="foreach: columnNames">
			            <th class="reshead"> <span data-bind="text: $data.colname">Loading ..</span>
			
			            </th>
			        </tr>
			    </thead>
			    <tbody data-bind="foreach: items">
			        <tr class="resrow" data-bind="foreach: $parent.columnNames, click: $root.selRow">
			            <td class="rescell">
							<div data-bind="visible: $data.type!='url'"><span data-bind="text: $parent[$data.colname]"></span></div>
							<div data-bind="visible: $data.type=='url'"><span data-bind="text: $parent[$data.colname]"></button></div>
						</td>
			        </tr>
			    </tbody>
			</table>
			</div>
		</div>
	
	<!-- selected item detail-->

		<div class="msgframe" data-bind="visible: $root.selectedRow()==false">
			<div class="msghead"><strong>Details</strong></div>
			<div class="msgcontent">
				<!-- span data-bind="text: $root.getCol('_id')"></span -->
				<div/>
				<!-- vertical display of row properties -->
				<table>
					 <tbody data-bind="foreach: $root.columnNames">
			        		<tr class="resrow">
			            			<td class="rescell">
								<div><span data-bind="text: $data.colname"></span></div>
							</td>
							<td class="rescell">
								<div><span data-bind="text: $root.getCol($data.colname)"></span></div>
							</td>
			        		</tr>
			    		</tbody>
				</table>
			
			</div>

		</div>
	</div>
</div>
        <!-- selected document options --> 

		<div class="msgframe" data-bind="visible: $root.selectedRow()">
			<div class="msghead" data-bind="click: $root.closeViewer, visible:$root.viewerVisible()==false"><strong>Preview  </strong>
				<span><button data-bind="click: $root.zoomOut">-</button><span data-bind="text: $root.viewerDensityP"></span>.0</span><span><button data-bind="click: $root.zoomIn">+</button></span>
			</div>
			<div class="preview">
				<img  class="previewPage" data-bind="click: $root.closeViewer, attr:{src: getThumbUrl}" />
				<img  class="previewPage" data-bind="visible: $root.viewerPages()>1, click: $root.openDoc1, attr:{src: getThumbUrl1}" />
			</div>
<div><button data-bind="click: $root.openDoc">Open</button><button data-bind="click: $root.perMail">Send to my mail</button></div>
<div><span data-bind="text: $root.viewerDensityP"></span></div>			
		</div>
		
	</body>

</html>


<!--Include JavaScripts for JQuery and Knockout.js <-->
<script type='text/javascript', src='js/jquery.js'></script>
<script type='text/javascript', src='js/knockout-min.js'></script>

<script type="text/javascript">
	
        // Here's my data model
        var viewModel = function () {


		var self=this;

		// tracks viewer visibility	
		self.viewerVisible = ko.observable();
	  
		// viewer resolution (in dpi). defaults ton 48 on startup.
		//self.viewerDensity = ko.observable(48);
	
	
	
		self.viewerDensityF = ko.observable(1.0);
		
		// viewer pages per frame (1-2). defaults to 2 on startup
		self.viewerPages = ko.observable(2);
	
		self.viewerDensityP = ko.computed(function() {
			// return 48; // self.viewerPages();
			if (self.viewerPages()==2) {
		    	return Math.round(48 * self.viewerDensityF());
			} else {
				return Math.round(128 * self.viewerDensityF());
		    }
		});
	
	
		// tracks resultlist items
        self.items = ko.observableArray();
	
		// track column names based on 1st item in items
		self.columnNames = ko.computed(function() {
			if (self.items().length === 0)
            			return [];
        		var props = [];
        		var obj = self.items()[0];
        		for (var name in obj) {
				if (name==='_id') {
					props.push({'colname':'_id', 'type':'url'});	
				} else {
					props.push({'colname':name, 'type':''});
				}
         		}
			
        		return props;
  		});

		// observes the selected row in result list
		self.selectedRow = ko.observable();

		// returns the value of a column identified by name from the selected row in result list
		self.getCol = function(col) {

			var jso = self.selectedRow();
			if (jso) {
				var run = jso[col];
				return run
			}
		};
  
/*
		self.selectedRowJ = ko.computed(function() {
			return  JSON.stringify(self.selectedRow());
		});
*/

		self.populate = function() {
			self.items.push({'Portfolio': '1001001','Pseudonym': 'LUNA', 'DocumentType':'Form A','Signed':'02.04.2014', 'Scanned':'03.04.2014', 'RunNr':'3454', '_id':1});
			 self.items.push({'Portfolio': '1001001','Pseudonym': 'LUNA', 'DocumentType':'Procuration','Signed':'03.04.2014', 'Scanned':'04.04.2014', 'RunNr':'5012', '_id':2});
			 self.items.push({'Portfolio': '1001001','Pseudonym': 'LUNA', 'DocumentType':'Non-US Disclosure','Signed':'03.04.2014', 'Scanned':'04.04.2014', 'RunNr':'3654', '_id':3});
			 self.items.push({'Portfolio': '1001001','Pseudonym': 'LUNA', 'DocumentType':'E-Banking contract','Signed':'04.04.2014', 'Scanned':'05.04.2014', 'RunNr':'5097', '_id':4});
						
			// self.items.push({'Artist': 'Brahms','Album': 'Klavierkonzert 1', 'DocumentType':'MP3'});
			// self.items.push({'Artist': 'Wagner','Album': 'Die WalkÃ¼rie', 'DocumentType':'CD'});
			// self.items.push({'Artist': 'Portishead','Album': 'Dummy', 'DocumentType':'WAV'});
	
		};

// Event handlers


		// called when user decrease resolution in viewer

		self.zoomOut = function() {
			var dpi = self.viewerDensityF();
			if (dpi > 0.2) {
				dpi = dpi - 0.1;
				self.viewerDensityF(dpi);	
			}
		};
	
		self.zoomIn = function() {
			var dpi = self.viewerDensityF();
			if (dpi < 10.0) {
				dpi = dpi + 0.1;
				self.viewerDensityF(dpi);	
			}
		};

	
		// called when user selects a row in result list
		self.selRow = function(row) {
			self.selectedRow(row);
			self.getThumbUrl();
			// alert(row._id.toString());
		};

		self.openDoc = function() {
			var id = self.getCol('_id');
			if (id) {
				window.location.href = "../pdf?density=196&page="+id.toString();	
			}
		}


		self.closeViewer = function() {
			self.viewerVisible(false);
			self.viewerPages(2);
		}
	
		self.openDoc1 = function() {
			self.viewerVisible(true);
			self.viewerPages(1);
			/* var id = self.getCol('_id');
			if (id) {
				id=id+1;
				window.location.href = "../pdf?density=96&page="+id.toString();	
			} */
		}

		self.getThumbUrl = ko.computed(function() {
			var id = self.getCol('_id');
			if (id) {
				return "../pdf?density="+self.viewerDensityP()+"&page="+id.toString();	
			}
		});

		self.getThumbUrl1 = ko.computed(function() {
			if (self.viewerPages()>1) {
				var id = self.getCol('_id');
				if (id) {
					id=id+1;
					return "../pdf?density="+self.viewerDensityP()+"&page="+id.toString();	
				}
			}
		});
	
		self.perMail = function() {
			$.get("permail");
		}
	
     	};
	
	
	
	
	var vm = new viewModel();
			vm.viewerVisible(false);
        ko.applyBindings(vm); // This makes Knockout get to work
	
	vm.populate();
		
 </script>
 
